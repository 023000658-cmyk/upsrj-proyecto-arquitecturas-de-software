<!-- ============================================================
Universidad Politécnica de Santa Rosa Jáuregui
Alumno: Maria Judith Guerrero Solis
Materia: Arquitecturas de Software
Profesor: Jesús Salvador López Ortega
Grupo: ISW28
Archivo: home.html
Descripción: Este archivo define la plantilla HTML principal del visor 
             de mensajes secretos. Muestra un token cifrado y su mensaje 
             descifrado dentro de una interfaz limpia y centrada. Utiliza 
             estilos CSS embebidos para mejorar la presentación visual, 
             incluyendo un diseño con fondo claro, bordes redondeados y 
             tipografía legible. Las variables {{ token }} y {{ message }} 
             se renderizan dinámicamente desde el backend mediante un 
             motor de plantillas como Jinja2.
============================================================ --> 

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor de Archivos Firmados</title>
    <style>
    :root {
        --dark-bg: #0b0b12;
        --dark-bg-2: #12121c;
        --dark-bg-3: #1a1a27;

        --gradient-1: #7e22ce;
        --gradient-2: #a21caf;
        --gradient-3: #ec4899;

        --glass-bg: rgba(255, 255, 255, 0.06);
        --glass-bg-2: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.15);

        --text-primary: #ffffff;
        --text-secondary: #c084fc;

        --accent: #e879f9;
        --accent-dark: #d946ef;

        --success: #22c55e;
        --warning: #facc15;

        --shadow-strong: 0 10px 60px rgba(0,0,0,0.55);
        --shadow-soft: 0 6px 30px rgba(0,0,0,0.45);
    }

    body {
        margin: 0;
        padding: 35px;
        min-height: 100vh;

        font-family: "Inter", sans-serif;
        color: var(--text-primary);

        background: var(--dark-bg);
        background: radial-gradient(circle at top, var(--dark-bg-3), var(--dark-bg));
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* TITULO */
    h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 2.6rem;
        letter-spacing: 1px;
        padding-bottom: 5px;

        background: linear-gradient(90deg, #fff, #e9d5ff, #ec4899);
        -webkit-background-clip: text;
        color: transparent;

        text-shadow: 0 4px 25px rgba(0,0,0,0.55);
    }

    /* WRAPPER */
    .upload-wrapper {
        width: 100%;
        max-width: 520px;

        padding: 2.5rem;
        margin-bottom: 2.5rem;

        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(18px);
        border-radius: 20px;

        box-shadow: var(--shadow-strong);
    }

    label {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }

    input[type="file"],
    select {
        width: 100%;
        padding: 12px;

        background: var(--glass-bg-2);
        backdrop-filter: blur(6px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;

        color: var(--text-primary);
        margin-bottom: 1.2rem;

        box-shadow: var(--shadow-soft);
    }

    /* BOTÓN */
    button {
        width: 100%;
        padding: 14px;

        border: none;
        border-radius: 14px;
        cursor: pointer;

        background: linear-gradient(90deg, var(--gradient-2), var(--gradient-3));
        color: white;

        font-weight: 700;
        font-size: 1rem;

        box-shadow: var(--shadow-strong);
        transition: 0.25s ease;
    }

    button:hover {
        transform: translateY(-3px);
        background: linear-gradient(90deg, var(--gradient-3), var(--gradient-1));
    }

    /* TABLA */
    .table-container {
        width: 100%;
        max-width: 1100px;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;

        background: var(--dark-bg-2);
        border-radius: 16px;

        border: 1px solid var(--glass-border);
        backdrop-filter: blur(8px);

        box-shadow: var(--shadow-strong);
    }

    th {
        padding: 1rem;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 1px;

        background: rgba(255,255,255,0.08);
        color: #f3c4fd;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        color: var(--text-secondary);
    }

    /* LINKS */
    a.download-link {
        color: #f0abfc;
        font-weight: 600;
        text-decoration: none;
        transition: 0.25s;
    }

    a.download-link:hover {
        color: #fff;
        text-shadow: 0 0 8px rgba(255,255,255,0.9);
    }

    /* BADGES */
    .status {
        padding: 6px 12px;
        font-size: 0.7rem;
        font-weight: bold;
        border-radius: 6px;
        text-transform: uppercase;
    }

    .status.signed {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        border: 1px solid var(--success);
    }

    .status.pending {
        background: rgba(250, 204, 21, 0.15);
        color: var(--warning);
        border: 1px solid var(--warning);
    }

    /* ENTORNOS */
    .environment { font-weight: bold; }
    .env-prod { color: #fb7185; }
    .env-dev { color: #a78bfa; }

    /* POPUP */
    #popup {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;

        padding: 18px 25px;
        border-radius: 14px;
        font-weight: 700;

        background: var(--accent-dark);
        color: white;
        backdrop-filter: blur(12px);

        box-shadow: var(--shadow-soft);
        animation: slideIn 0.45s ease-out;
        z-index: 1000;
    }

    @keyframes slideIn {
        from { transform: translateX(160%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>

</head>

<body>

    <h1>OTA Signer Aplication</h1>

    <div class="upload-wrapper">
        <form id="uploadForm">
            <div class="form-group">
                <label for="file">Archivo a procesar</label>
                <input type="file" id="file" name="file" required>
                <small id="fileNameDisplay"></small>
            </div>

            <div class="form-group">
                <label for="environment">Modo de procesamiento:</label>
                <select id="environment" name="environment">
                    <option value="dev">Desarrollo (firma inmediata)</option>
                    <option value="prod">Producción (requiere autorización)</option>
                </select>
            </div>

            <button type="submit">Procesar Archivo</button>
        </form>
    </div>

    <div class="table-container">
        <table class="file-list-container">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Entorno</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acción</th>
                    <th>Hash</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="popup"></div>

    <script>
        const fileInput = document.getElementById('file');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const form = document.getElementById('uploadForm');
        const popup = document.getElementById('popup');
        const tableBody = document.querySelector('.file-list-container tbody');

        document.addEventListener('DOMContentLoaded', loadFiles);

        async function loadFiles() {
            try {
                const response = await fetch('/files');
                if (response.ok) {
                    const files = await response.json();
                    tableBody.innerHTML = '';
                    files.reverse().forEach(file => addRowToTable(file));
                }
            } catch (e) {
                console.error("Error al cargar la lista:", e);
            }
        }

        function addRowToTable(file) {
            const row = document.createElement('tr');

            const id = file.id ? file.id.substring(0, 8) + "..." : "—";
            const sig = file.signature ? file.signature.substring(0, 12) + "..." : "—";
            let dateStr = file.uploaded_at || file.uploaded_date || "—";
            if (dateStr.includes("T")) dateStr = dateStr.split("T")[0];

            const action = file.signed_path
                ? `<a class="download-link" href="#" onclick="alert('Ubicación del archivo firmado: ${file.signed_path}')">Ver</a>`
                : "—";

            row.innerHTML = `
                <td style="font-family: monospace; color: var(--text-secondary);">${id}</td>
                <td>${file.filename}</td>
                <td class="environment env-${file.environment}">${file.environment}</td>
                <td><span class="status ${file.status}">${file.status}</span></td>
                <td>${dateStr}</td>
                <td>${action}</td>
                <td style="font-family: monospace; color: var(--text-secondary);">${sig}</td>
            `;

            tableBody.appendChild(row);
        }

        fileInput.addEventListener("change", () => {
            const fileName = fileInput.files.length ? fileInput.files[0].name : "";
            fileNameDisplay.textContent = fileName ? "Seleccionado: " + fileName : "";
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector("button");
            submitBtn.disabled = true;
            submitBtn.textContent = "Procesando...";

            const formData = new FormData(form);
            const env = document.getElementById("environment").value;
            const isProd = env === "prod";

            try {
                const uploadResp = await fetch("/upload", { method: "POST", body: formData });
                if (!uploadResp.ok) throw new Error("No se pudo subir el archivo");

                const uploaded = await uploadResp.json();
                let processed = uploaded;

                if (!isProd) {
                    const signResp = await fetch("/sign", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({ file_id: uploaded.id })
                    });

                    if (!signResp.ok) throw new Error("Error durante la firma");
                    processed = await signResp.json();
                }

                popup.style.backgroundColor = processed.status === "signed"
                    ? "var(--color-success)"
                    : "var(--color-warning)";

                popup.textContent = processed.status === "signed"
                    ? "Archivo procesado y firmado correctamente."
                    : "Archivo registrado. Requiere aprobación.";

                popup.style.display = "block";
                setTimeout(() => popup.style.display = "none", 3500);

                form.reset();
                fileNameDisplay.textContent = "";

                tableBody.innerHTML = "";
                loadFiles();

            } catch (err) {
                popup.style.backgroundColor = "var(--color-accent-dark)";
                popup.textContent = "Error: " + err.message;
                popup.style.display = "block";
                setTimeout(() => popup.style.display = "none", 3000);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Procesar Archivo";
            }
        });
    </script>

</body>
</html>